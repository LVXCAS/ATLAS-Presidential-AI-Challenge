# Backup service for automated database and data backups
FROM alpine:3.18

# Install required packages
RUN apk add --no-cache \
    postgresql-client \
    aws-cli \
    curl \
    tar \
    gzip \
    bash \
    dcron \
    logrotate

# Create backup user
RUN addgroup -g 1000 backup && \
    adduser -u 1000 -G backup -s /bin/bash -D backup

# Set working directory
WORKDIR /app

# Copy backup scripts
COPY docker/scripts/backup/ /app/scripts/
RUN chmod +x /app/scripts/*.sh

# Create backup directories
RUN mkdir -p /backups/db /backups/data /backups/logs && \
    chown -R backup:backup /backups /app

# Copy crontab
COPY docker/cron/backup-cron /etc/crontabs/backup

# Copy logrotate configuration
COPY docker/logrotate/backup /etc/logrotate.d/backup

# Switch to backup user
USER backup

# Health check
HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
  CMD /app/scripts/health-check.sh

# Default command starts cron in foreground
CMD ["crond", "-f", "-d", "8"]