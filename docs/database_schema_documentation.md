# LangGraph Trading System - Database Schema Documentation

## Overview

This document provides comprehensive documentation for the LangGraph Adaptive Multi-Strategy AI Trading System database schema. The schema is designed to support high-frequency trading operations across global markets with 50,000+ symbols, real-time data processing, and comprehensive audit trails.

## Architecture Principles

### Time-Series Optimization
- **TimescaleDB Integration**: All high-frequency tables are implemented as hypertables for optimal time-series performance
- **Partitioning Strategy**: Data is automatically partitioned by time for efficient queries and maintenance
- **Compression**: Automatic compression of older data to reduce storage costs
- **Retention Policies**: Automated data lifecycle management with configurable retention periods

### Performance Optimization
- **Strategic Indexing**: Comprehensive indexing strategy optimized for trading workloads
- **Materialized Views**: Pre-computed aggregations for frequently accessed metrics
- **Query Optimization**: PostgreSQL settings tuned for high-throughput OLTP workloads
- **Connection Pooling**: Optimized connection management for concurrent agent operations

### Data Integrity
- **Comprehensive Triggers**: Automated data validation and audit trail generation
- **Referential Integrity**: Foreign key constraints where appropriate
- **Business Logic Validation**: Database-level validation of trading rules
- **Audit Trail**: Complete audit trail for all critical operations

## Table Categories

### 1. Market Data Tables

#### market_data_hf
High-frequency market data (1-minute bars and ticks)
- **Purpose**: Store real-time and historical market data across all timeframes
- **Optimization**: TimescaleDB hypertable with 1-day chunks
- **Retention**: 2 years with compression after 7 days
- **Volume**: ~50M records/day for 50K symbols

```sql
CREATE TABLE market_data_hf (
    timestamp TIMESTAMPTZ NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    exchange VARCHAR(20) NOT NULL,
    timeframe VARCHAR(10) NOT NULL,
    open/high/low/close DECIMAL(15,8),
    volume BIGINT,
    quality_score DECIMAL(5,4),
    PRIMARY KEY (timestamp, symbol, exchange, timeframe)
);
```

#### market_data_daily
Daily aggregated market data for long-term analysis
- **Purpose**: Store daily OHLCV data with additional metrics
- **Optimization**: Regular table with date-based indexing
- **Retention**: Permanent (regulatory requirement)

#### options_data
Options chain data with Greeks calculation
- **Purpose**: Store options pricing and Greeks for volatility strategies
- **Optimization**: TimescaleDB hypertable
- **Retention**: 1 year with compression after 30 days

#### forex_crypto_data
Foreign exchange and cryptocurrency data
- **Purpose**: Support global trading across FX and crypto markets
- **Optimization**: TimescaleDB hypertable
- **Retention**: 2 years with compression after 7 days

### 2. Signal Generation Tables

#### signals
Raw signals from individual trading agents
- **Purpose**: Store all signals generated by trading agents
- **Key Features**: 
  - Top-3 reasons for explainability
  - Fibonacci levels and technical indicators
  - Sentiment data integration
  - Model version tracking

```sql
CREATE TABLE signals (
    timestamp TIMESTAMPTZ NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    agent_name VARCHAR(50) NOT NULL,
    signal_type VARCHAR(30) NOT NULL,
    value DECIMAL(10,6) NOT NULL,
    confidence DECIMAL(5,4) NOT NULL,
    top_3_reasons JSONB NOT NULL,
    fibonacci_levels JSONB,
    sentiment_data JSONB,
    model_version VARCHAR(20) NOT NULL,
    PRIMARY KEY (timestamp, symbol, agent_name, signal_type)
);
```

#### fused_signals
Portfolio Allocator output after signal fusion
- **Purpose**: Store final trading signals after multi-agent fusion
- **Key Features**:
  - Conflict resolution metadata
  - Cross-market arbitrage opportunities
  - Risk-adjusted position sizing
  - Contributing agent weights

#### signal_performance
Historical performance tracking for all signals
- **Purpose**: Track accuracy and profitability of agent signals
- **Key Metrics**: Accuracy score, actual vs predicted returns, hit rate

### 3. Trading and Execution Tables

#### orders
Complete order lifecycle management
- **Purpose**: Track all orders from submission to completion
- **Key Features**:
  - Parent-child order relationships for algorithmic execution
  - Multiple broker support
  - Execution algorithm tracking (TWAP, VWAP, etc.)
  - Real-time status updates

```sql
CREATE TABLE orders (
    submitted_at TIMESTAMPTZ NOT NULL,
    order_id VARCHAR(50) NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    side VARCHAR(10) NOT NULL,
    order_type VARCHAR(20) NOT NULL,
    quantity DECIMAL(15,6) NOT NULL,
    status VARCHAR(20) NOT NULL,
    broker VARCHAR(20) NOT NULL,
    execution_algo VARCHAR(30),
    PRIMARY KEY (submitted_at, order_id)
);
```

#### trades
All trade executions and fills
- **Purpose**: Record all trade executions with detailed metrics
- **Key Features**:
  - Commission and fee tracking
  - Market impact and slippage measurement
  - Multi-currency support
  - Execution quality scoring

#### positions
Real-time position tracking
- **Purpose**: Maintain current portfolio positions
- **Key Features**:
  - Real-time P&L calculation
  - Average cost tracking
  - Strategy and agent attribution
  - Automatic updates via triggers

#### portfolio_snapshots
Historical portfolio state tracking
- **Purpose**: Time-series of portfolio metrics
- **Optimization**: TimescaleDB hypertable with 1-hour chunks
- **Key Metrics**: Total value, exposures, leverage, sector allocations

### 4. Risk Management Tables

#### risk_metrics
Real-time risk monitoring
- **Purpose**: Store comprehensive risk metrics
- **Key Features**:
  - VaR and Expected Shortfall calculation
  - Factor exposure tracking
  - Concentration risk monitoring
  - Stress test results

```sql
CREATE TABLE risk_metrics (
    timestamp TIMESTAMPTZ NOT NULL,
    portfolio_value DECIMAL(15,6) NOT NULL,
    var_1d_95 DECIMAL(15,6),
    var_1d_99 DECIMAL(15,6),
    leverage DECIMAL(8,4) NOT NULL,
    factor_exposures JSONB,
    stress_test_results JSONB,
    PRIMARY KEY (timestamp)
);
```

#### risk_alerts
Risk limit breaches and alerts
- **Purpose**: Track all risk events and responses
- **Key Features**:
  - Severity classification
  - Automatic alert generation
  - Action tracking and resolution

#### factor_exposures
Factor exposure tracking over time
- **Purpose**: Monitor exposure to systematic risk factors
- **Factors**: Momentum, Value, Growth, Quality, Volatility, etc.

### 5. Performance Tracking Tables

#### model_performance
Comprehensive model performance metrics
- **Purpose**: Track performance of all trading models and strategies
- **Key Metrics**: 
  - Risk-adjusted returns (Sharpe, Sortino, Calmar)
  - Drawdown analysis
  - Trade statistics
  - Factor attribution

```sql
CREATE TABLE model_performance (
    end_date DATE NOT NULL,
    model_name VARCHAR(50) NOT NULL,
    strategy VARCHAR(30) NOT NULL,
    total_return DECIMAL(10,6),
    sharpe_ratio DECIMAL(8,4),
    max_drawdown DECIMAL(8,4),
    alpha DECIMAL(8,4),
    beta DECIMAL(8,4),
    PRIMARY KEY (end_date, model_name, strategy)
);
```

### 6. News and Alternative Data Tables

#### news_articles
News articles with sentiment analysis
- **Purpose**: Store news data with AI-powered sentiment analysis
- **Key Features**:
  - Multi-source aggregation
  - FinBERT + Gemini/DeepSeek sentiment scoring
  - Market impact prediction
  - Symbol relationship mapping

#### social_sentiment
Social media sentiment tracking
- **Purpose**: Track sentiment from Twitter, Reddit, StockTwits
- **Key Features**:
  - Platform-specific sentiment scores
  - Trending analysis
  - Viral content detection

#### alternative_data
Alternative data sources integration
- **Purpose**: Store satellite, credit card, weather, and other alternative data
- **Key Features**:
  - Flexible schema for different data types
  - Confidence scoring
  - Provider attribution

### 7. System Monitoring Tables

#### system_logs
Comprehensive system logging
- **Purpose**: Store all system events and errors
- **Optimization**: TimescaleDB hypertable with 1-day chunks
- **Retention**: 90 days with compression after 7 days

#### agent_metrics
Agent performance and health monitoring
- **Purpose**: Track individual agent performance and resource usage
- **Key Metrics**: CPU usage, memory, response times, error rates

#### audit_trail
Complete audit trail for compliance
- **Purpose**: Regulatory compliance and forensic analysis
- **Key Features**:
  - Before/after state tracking
  - User and system action attribution
  - Complete change history

### 8. Backtesting Tables

#### backtest_runs
Backtest execution tracking
- **Purpose**: Store backtest configurations and results
- **Key Features**:
  - Strategy configuration storage
  - Performance metrics
  - Execution time tracking

#### backtest_trades
Detailed backtest trade history
- **Purpose**: Store all simulated trades from backtests
- **Key Features**:
  - Complete trade details
  - Signal strength correlation
  - Market regime attribution

## Database Functions

### Portfolio Management Functions

#### calculate_portfolio_metrics()
Returns real-time portfolio metrics including total value, exposures, and leverage.

```sql
SELECT * FROM calculate_portfolio_metrics();
```

#### calculate_var(confidence_level, lookback_days)
Calculates Value at Risk using historical simulation method.

```sql
SELECT * FROM calculate_var(0.95, 252);
```

### Performance Analysis Functions

#### calculate_signal_performance(agent_name, lookback_days)
Analyzes signal performance for a specific agent over a time period.

```sql
SELECT * FROM calculate_signal_performance('momentum_agent', 30);
```

### Data Quality Functions

#### detect_market_data_anomalies(symbol, lookback_hours)
Identifies anomalies in market data using statistical methods.

```sql
SELECT * FROM detect_market_data_anomalies('AAPL', 24);
```

### Maintenance Functions

#### daily_maintenance()
Performs daily database maintenance tasks including view refresh and cleanup.

#### weekly_maintenance()
Performs weekly maintenance including reindexing and full analysis.

## Triggers and Automation

### Data Integrity Triggers

#### validate_trade_data()
Validates all trade data before insertion:
- Positive prices
- Non-zero quantities
- Side/quantity consistency

#### update_position_from_trade()
Automatically updates positions when trades are executed:
- Calculates new position size
- Updates average cost
- Handles position closing

### Audit Triggers

#### log_audit_trail()
Automatically logs all changes to critical tables:
- Before/after state capture
- User attribution
- Timestamp tracking

### Portfolio Triggers

#### update_portfolio_snapshot()
Creates portfolio snapshots when positions change:
- Real-time portfolio metrics
- Automatic snapshot generation
- Historical tracking

## Indexing Strategy

### Time-Series Indexes
- Primary indexes on (timestamp, symbol) for all time-series tables
- Composite indexes for common query patterns
- Partial indexes for filtered queries

### Performance Indexes
- Indexes on frequently filtered columns (strategy, agent_name, status)
- Covering indexes for common SELECT patterns
- GIN indexes for JSONB columns

### Unique Constraints
- Natural keys for data integrity
- Composite unique constraints for business rules

## Data Retention and Archival

### Retention Policies
- **High-frequency data**: 2 years
- **Daily data**: Permanent
- **Trades/Orders**: 7 years (regulatory)
- **System logs**: 90 days
- **News data**: 1 year

### Compression Policies
- **Market data**: 7 days
- **Signals**: 30 days
- **Trades**: 90 days
- **System logs**: 7 days

### Archival Strategy
- Automatic compression of older data
- Cold storage migration for historical data
- Backup and recovery procedures

## Security and Access Control

### User Roles

#### trading_app
Application user with limited permissions:
- SELECT, INSERT, UPDATE on operational tables
- No DELETE permissions (except specific tables)
- Function execution permissions

#### trading_readonly
Read-only user for reporting and analysis:
- SELECT permissions on all tables
- View access for monitoring
- No modification permissions

### Security Features
- Row-level security for multi-tenant scenarios
- Encrypted connections required
- Audit logging for all access
- Regular security updates

## Monitoring and Alerting

### System Health Views

#### system_health
Real-time system health metrics:
- Database connections
- Cache hit ratios
- Database size

#### trading_metrics
Trading system specific metrics:
- Position counts
- Daily trade volume
- Signal activity

### Performance Monitoring
- Query performance tracking
- Index usage analysis
- Table size monitoring
- Connection pool metrics

## Backup and Recovery

### Backup Strategy
- Continuous WAL archiving
- Daily full backups
- Point-in-time recovery capability
- Cross-region backup replication

### Recovery Procedures
- Automated failover for high availability
- 30-second recovery time objective
- Complete disaster recovery procedures
- Regular recovery testing

## Maintenance Procedures

### Daily Maintenance
- Materialized view refresh
- Statistics updates
- Log cleanup
- Performance monitoring

### Weekly Maintenance
- Full table analysis
- Index maintenance
- Vacuum operations
- Performance optimization

### Monthly Maintenance
- Full backup verification
- Security audit
- Capacity planning
- Performance tuning

## Performance Characteristics

### Expected Throughput
- **Market data ingestion**: 100K+ records/second
- **Signal generation**: 10K+ signals/second
- **Trade execution**: 1K+ trades/second
- **Query response**: <100ms for 95th percentile

### Scalability Limits
- **Symbols supported**: 50,000+
- **Concurrent connections**: 200
- **Data retention**: 2+ years of high-frequency data
- **Storage growth**: ~1TB/year for full system

## Troubleshooting Guide

### Common Issues

#### Slow Query Performance
1. Check index usage with `monitor_index_usage()`
2. Analyze query plans
3. Update table statistics
4. Consider index optimization

#### High Memory Usage
1. Monitor connection count
2. Check work_mem settings
3. Analyze query complexity
4. Consider connection pooling

#### Disk Space Issues
1. Check retention policies
2. Verify compression settings
3. Monitor log file growth
4. Consider archival procedures

### Diagnostic Queries

#### Database Performance
```sql
SELECT * FROM get_database_performance_metrics();
```

#### Table Statistics
```sql
SELECT * FROM analyze_table_statistics();
```

#### Slow Queries
```sql
SELECT * FROM get_slow_queries('5 seconds');
```

## Future Enhancements

### Planned Improvements
- **Horizontal Scaling**: Implement sharding for ultra-high volume
- **Real-time Analytics**: Stream processing integration
- **Machine Learning**: In-database ML model execution
- **Global Distribution**: Multi-region data replication

### Technology Roadmap
- **PostgreSQL 16+**: Latest performance improvements
- **TimescaleDB 3.0+**: Enhanced compression and analytics
- **Kubernetes**: Container orchestration for scalability
- **Cloud Integration**: Multi-cloud deployment support

This comprehensive database schema provides the foundation for a production-ready, high-performance trading system capable of handling institutional-scale operations while maintaining data integrity, regulatory compliance, and operational excellence.