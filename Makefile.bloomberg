# Bloomberg Terminal Trading System - Professional Makefile
# High-performance deployment and development commands

.PHONY: all setup dev build deploy test clean help
.DEFAULT_GOAL := help

# Configuration
PROJECT_NAME := bloomberg-terminal
DOCKER_COMPOSE_FILE := docker-compose.bloomberg.yml
BACKEND_DIR := backend
FRONTEND_DIR := frontend

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
MAGENTA := \033[0;35m
CYAN := \033[0;36m
WHITE := \033[1;37m
RESET := \033[0m

## System Setup Commands

setup: ## ğŸš€ Complete system setup (first time installation)
	@echo "$(CYAN)â”â”â” BLOOMBERG TERMINAL SYSTEM SETUP â”â”â”$(RESET)"
	@echo "$(YELLOW)Setting up infrastructure...$(RESET)"
	$(MAKE) setup-infrastructure
	@echo "$(YELLOW)Setting up backend...$(RESET)"
	$(MAKE) setup-backend
	@echo "$(YELLOW)Setting up frontend...$(RESET)"
	$(MAKE) setup-frontend
	@echo "$(GREEN)âœ… System setup complete!$(RESET)"

setup-infrastructure: ## ğŸ—ï¸ Set up Docker infrastructure
	@echo "$(BLUE)Starting infrastructure services...$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) up -d timescaledb redis prometheus grafana
	@echo "$(BLUE)Waiting for services to be ready...$(RESET)"
	sleep 10
	@echo "$(GREEN)Infrastructure ready$(RESET)"

setup-backend: ## ğŸ Set up Python backend
	@echo "$(BLUE)Setting up backend dependencies...$(RESET)"
	cd $(BACKEND_DIR) && pip install -r requirements.txt
	@echo "$(BLUE)Running database migrations...$(RESET)"
	# Add database migration commands here
	@echo "$(GREEN)Backend setup complete$(RESET)"

setup-frontend: ## âš›ï¸ Set up React frontend
	@echo "$(BLUE)Installing frontend dependencies...$(RESET)"
	cd $(FRONTEND_DIR) && npm install
	@echo "$(GREEN)Frontend setup complete$(RESET)"

## Development Commands

dev: ## ğŸ”§ Start development environment
	@echo "$(CYAN)â”â”â” STARTING DEVELOPMENT ENVIRONMENT â”â”â”$(RESET)"
	$(MAKE) dev-infrastructure
	$(MAKE) dev-backend &
	$(MAKE) dev-frontend &
	@echo "$(GREEN)ğŸš€ Development environment started!$(RESET)"
	@echo "$(YELLOW)Frontend: http://localhost:3000$(RESET)"
	@echo "$(YELLOW)Backend API: http://localhost:8000$(RESET)"
	@echo "$(YELLOW)Grafana: http://localhost:3001$(RESET)"

dev-infrastructure: ## ğŸ—ï¸ Start development infrastructure
	docker-compose -f $(DOCKER_COMPOSE_FILE) up -d timescaledb redis prometheus grafana elasticsearch kibana

dev-backend: ## ğŸ Start backend development server
	@echo "$(BLUE)Starting backend development server...$(RESET)"
	cd $(BACKEND_DIR) && python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload

dev-frontend: ## âš›ï¸ Start frontend development server
	@echo "$(BLUE)Starting frontend development server...$(RESET)"
	cd $(FRONTEND_DIR) && npm start

## Production Commands

build: ## ğŸ—ï¸ Build production images
	@echo "$(CYAN)â”â”â” BUILDING PRODUCTION IMAGES â”â”â”$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) build --no-cache
	@echo "$(GREEN)âœ… Build complete$(RESET)"

deploy: ## ğŸš€ Deploy production system
	@echo "$(CYAN)â”â”â” DEPLOYING BLOOMBERG TERMINAL â”â”â”$(RESET)"
	@echo "$(YELLOW)Stopping existing containers...$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) down
	@echo "$(YELLOW)Starting production deployment...$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) up -d --build
	@echo "$(YELLOW)Waiting for services to be healthy...$(RESET)"
	sleep 30
	$(MAKE) health-check
	@echo "$(GREEN)ğŸ‰ DEPLOYMENT SUCCESSFUL!$(RESET)"
	@echo "$(WHITE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo "$(GREEN)Bloomberg Terminal: http://localhost:3000$(RESET)"
	@echo "$(GREEN)API Documentation: http://localhost:8000/docs$(RESET)"
	@echo "$(GREEN)Monitoring: http://localhost:3001$(RESET)"
	@echo "$(GREEN)Logs: http://localhost:5601$(RESET)"
	@echo "$(WHITE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"

## Testing Commands

test: ## ğŸ§ª Run all tests
	@echo "$(CYAN)â”â”â” RUNNING ALL TESTS â”â”â”$(RESET)"
	$(MAKE) test-backend
	$(MAKE) test-frontend
	@echo "$(GREEN)âœ… All tests passed$(RESET)"

test-backend: ## ğŸ§ª Run backend tests
	@echo "$(BLUE)Running backend tests...$(RESET)"
	cd $(BACKEND_DIR) && python -m pytest tests/ -v --cov=.

test-frontend: ## ğŸ§ª Run frontend tests
	@echo "$(BLUE)Running frontend tests...$(RESET)"
	cd $(FRONTEND_DIR) && npm test -- --coverage --watchAll=false

test-integration: ## ğŸ§ª Run integration tests
	@echo "$(BLUE)Running integration tests...$(RESET)"
	cd $(BACKEND_DIR) && python -m pytest tests/integration/ -v

test-performance: ## ğŸ§ª Run performance tests
	@echo "$(BLUE)Running performance tests...$(RESET)"
	# Add performance testing commands here

## System Management Commands

start: ## â–¶ï¸ Start all services
	@echo "$(GREEN)Starting Bloomberg Terminal...$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) up -d

stop: ## â¹ï¸ Stop all services
	@echo "$(YELLOW)Stopping Bloomberg Terminal...$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) down

restart: ## ğŸ”„ Restart all services
	@echo "$(YELLOW)Restarting Bloomberg Terminal...$(RESET)"
	$(MAKE) stop
	sleep 5
	$(MAKE) start

status: ## ğŸ“Š Show service status
	@echo "$(CYAN)â”â”â” SYSTEM STATUS â”â”â”$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) ps

logs: ## ğŸ“‹ Show logs from all services
	docker-compose -f $(DOCKER_COMPOSE_FILE) logs -f

logs-backend: ## ğŸ“‹ Show backend logs
	docker-compose -f $(DOCKER_COMPOSE_FILE) logs -f backend

logs-frontend: ## ğŸ“‹ Show frontend logs
	docker-compose -f $(DOCKER_COMPOSE_FILE) logs -f frontend

## Health and Monitoring Commands

health-check: ## ğŸ” Perform comprehensive health check
	@echo "$(CYAN)â”â”â” HEALTH CHECK â”â”â”$(RESET)"
	@echo "$(BLUE)Checking backend API...$(RESET)"
	@curl -f http://localhost:8000/health || (echo "$(RED)âŒ Backend unhealthy$(RESET)" && exit 1)
	@echo "$(GREEN)âœ… Backend healthy$(RESET)"
	@echo "$(BLUE)Checking frontend...$(RESET)"
	@curl -f http://localhost:3000 > /dev/null || (echo "$(RED)âŒ Frontend unhealthy$(RESET)" && exit 1)
	@echo "$(GREEN)âœ… Frontend healthy$(RESET)"
	@echo "$(BLUE)Checking TimescaleDB...$(RESET)"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec -T timescaledb pg_isready || (echo "$(RED)âŒ Database unhealthy$(RESET)" && exit 1)
	@echo "$(GREEN)âœ… Database healthy$(RESET)"
	@echo "$(GREEN)ğŸ‰ ALL SYSTEMS HEALTHY$(RESET)"

metrics: ## ğŸ“ˆ Show system metrics
	@echo "$(CYAN)â”â”â” SYSTEM METRICS â”â”â”$(RESET)"
	@echo "$(YELLOW)Docker Stats:$(RESET)"
	@docker stats --no-stream
	@echo "$(YELLOW)Disk Usage:$(RESET)"
	@df -h | grep -E "(Filesystem|/dev/)"
	@echo "$(YELLOW)API Metrics:$(RESET)"
	@curl -s http://localhost:8000/metrics | head -20

monitor: ## ğŸ–¥ï¸ Open monitoring dashboards
	@echo "$(GREEN)Opening monitoring dashboards...$(RESET)"
	@echo "Grafana: http://localhost:3001 (admin/bloomberg123)"
	@echo "Kibana: http://localhost:5601"
	@echo "API Docs: http://localhost:8000/docs"

## Data Management Commands

backup: ## ğŸ’¾ Backup system data
	@echo "$(CYAN)â”â”â” CREATING BACKUP â”â”â”$(RESET)"
	@mkdir -p backups/$(shell date +%Y%m%d_%H%M%S)
	@echo "$(BLUE)Backing up database...$(RESET)"
	docker-compose -f $(DOCKER_COMPOSE_FILE) exec -T timescaledb pg_dump -U trading_user bloomberg_trading > backups/$(shell date +%Y%m%d_%H%M%S)/database.sql
	@echo "$(BLUE)Backing up configuration...$(RESET)"
	@cp -r config backups/$(shell date +%Y%m%d_%H%M%S)/
	@echo "$(GREEN)âœ… Backup complete$(RESET)"

restore: ## ğŸ“¥ Restore system data
	@echo "$(RED)âš ï¸  This will overwrite existing data!$(RESET)"
	@echo "Enter backup directory name: "; read backup_dir; \
	docker-compose -f $(DOCKER_COMPOSE_FILE) exec -T timescaledb psql -U trading_user -d bloomberg_trading < backups/$$backup_dir/database.sql

## Security Commands

security-scan: ## ğŸ”’ Run security scans
	@echo "$(CYAN)â”â”â” SECURITY SCAN â”â”â”$(RESET)"
	@echo "$(BLUE)Scanning Docker images...$(RESET)"
	# docker scan bloomberg-terminal-backend
	# docker scan bloomberg-terminal-frontend
	@echo "$(BLUE)Checking for vulnerabilities...$(RESET)"
	cd $(BACKEND_DIR) && safety check
	cd $(FRONTEND_DIR) && npm audit

update-deps: ## ğŸ“¦ Update dependencies
	@echo "$(CYAN)â”â”â” UPDATING DEPENDENCIES â”â”â”$(RESET)"
	@echo "$(BLUE)Updating backend dependencies...$(RESET)"
	cd $(BACKEND_DIR) && pip-review --local --auto
	@echo "$(BLUE)Updating frontend dependencies...$(RESET)"
	cd $(FRONTEND_DIR) && npm update

## Database Commands

db-reset: ## ğŸ—„ï¸ Reset database (DESTRUCTIVE)
	@echo "$(RED)âš ï¸  This will delete all data!$(RESET)"
	@echo "Are you sure? [y/N]: "; read confirm; [ "$$confirm" = "y" ] || exit 1
	docker-compose -f $(DOCKER_COMPOSE_FILE) down -v
	docker-compose -f $(DOCKER_COMPOSE_FILE) up -d timescaledb
	sleep 10
	@echo "$(GREEN)Database reset complete$(RESET)"

db-migrate: ## ğŸ—„ï¸ Run database migrations
	@echo "$(BLUE)Running database migrations...$(RESET)"
	# Add migration commands here

db-shell: ## ğŸ—„ï¸ Connect to database shell
	docker-compose -f $(DOCKER_COMPOSE_FILE) exec timescaledb psql -U trading_user -d bloomberg_trading

## Emergency Commands

emergency-stop: ## ğŸš¨ EMERGENCY STOP - Halt all trading operations
	@echo "$(RED)ğŸš¨ EMERGENCY STOP ACTIVATED ğŸš¨$(RESET)"
	@curl -X POST http://localhost:8000/emergency/stop || true
	$(MAKE) stop
	@echo "$(RED)ğŸ›‘ ALL TRADING OPERATIONS HALTED$(RESET)"

emergency-restart: ## ğŸš¨ Emergency restart with health checks
	@echo "$(RED)ğŸš¨ EMERGENCY RESTART SEQUENCE ğŸš¨$(RESET)"
	$(MAKE) emergency-stop
	sleep 10
	$(MAKE) deploy
	$(MAKE) health-check

## Development Tools

shell-backend: ## ğŸ Open backend shell
	docker-compose -f $(DOCKER_COMPOSE_FILE) exec backend bash

shell-frontend: ## âš›ï¸ Open frontend shell
	docker-compose -f $(DOCKER_COMPOSE_FILE) exec frontend sh

lint: ## ğŸ§¹ Lint all code
	@echo "$(CYAN)â”â”â” LINTING CODE â”â”â”$(RESET)"
	@echo "$(BLUE)Linting backend...$(RESET)"
	cd $(BACKEND_DIR) && black . && isort . && flake8 .
	@echo "$(BLUE)Linting frontend...$(RESET)"
	cd $(FRONTEND_DIR) && npm run lint:fix

format: ## ğŸ’… Format all code
	@echo "$(CYAN)â”â”â” FORMATTING CODE â”â”â”$(RESET)"
	cd $(BACKEND_DIR) && black .
	cd $(FRONTEND_DIR) && npx prettier --write src/

## Cleanup Commands

clean: ## ğŸ§¹ Clean up system
	@echo "$(CYAN)â”â”â” CLEANING SYSTEM â”â”â”$(RESET)"
	$(MAKE) clean-docker
	$(MAKE) clean-deps
	@echo "$(GREEN)âœ… System cleaned$(RESET)"

clean-docker: ## ğŸ³ Clean Docker resources
	@echo "$(BLUE)Cleaning Docker resources...$(RESET)"
	docker system prune -f
	docker volume prune -f

clean-deps: ## ğŸ“¦ Clean dependency files
	@echo "$(BLUE)Cleaning dependency files...$(RESET)"
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	find . -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true

## Information Commands

info: ## â„¹ï¸ Show system information
	@echo "$(CYAN)â”â”â” BLOOMBERG TERMINAL SYSTEM INFO â”â”â”$(RESET)"
	@echo "$(YELLOW)Project:$(RESET) $(PROJECT_NAME)"
	@echo "$(YELLOW)Docker Compose:$(RESET) $(DOCKER_COMPOSE_FILE)"
	@echo "$(YELLOW)Backend:$(RESET) $(BACKEND_DIR)"
	@echo "$(YELLOW)Frontend:$(RESET) $(FRONTEND_DIR)"
	@echo "$(YELLOW)System Status:$(RESET)"
	@$(MAKE) status 2>/dev/null || echo "Not running"

ports: ## ğŸ”Œ Show port mappings
	@echo "$(CYAN)â”â”â” PORT MAPPINGS â”â”â”$(RESET)"
	@echo "$(YELLOW)3000$(RESET) - Bloomberg Terminal UI"
	@echo "$(YELLOW)8000$(RESET) - Backend API"
	@echo "$(YELLOW)8001$(RESET) - WebSocket Server"
	@echo "$(YELLOW)5432$(RESET) - TimescaleDB"
	@echo "$(YELLOW)6379$(RESET) - Redis"
	@echo "$(YELLOW)9090$(RESET) - Prometheus"
	@echo "$(YELLOW)3001$(RESET) - Grafana"
	@echo "$(YELLOW)9200$(RESET) - Elasticsearch"
	@echo "$(YELLOW)5601$(RESET) - Kibana"

help: ## ğŸ“š Show this help message
	@echo "$(CYAN)â”â”â” BLOOMBERG TERMINAL COMMAND REFERENCE â”â”â”$(RESET)"
	@echo ""
	@echo "$(WHITE)ğŸš€ QUICK START:$(RESET)"
	@echo "  $(GREEN)make setup$(RESET)    - First time setup"
	@echo "  $(GREEN)make dev$(RESET)      - Start development"
	@echo "  $(GREEN)make deploy$(RESET)   - Deploy production"
	@echo ""
	@echo "$(WHITE)ğŸ“‹ AVAILABLE COMMANDS:$(RESET)"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(GREEN)%-18s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(WHITE)ğŸš¨ EMERGENCY COMMANDS:$(RESET)"
	@echo "  $(RED)make emergency-stop$(RESET)     - Stop all trading"
	@echo "  $(RED)make emergency-restart$(RESET)  - Emergency restart"
	@echo ""
	@echo "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"

# Include additional makefiles for specific environments
-include Makefile.local